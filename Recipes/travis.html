<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Behat Extension</title>

    <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic'
          rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="https://stephenharris.github.io/WordPressBehatExtension/css/grid.css" type="text/css"/>
    <link rel="stylesheet" href="https://stephenharris.github.io/WordPressBehatExtension/css/theme.css" type="text/css"/>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.9.0/styles/dark.min.css">
</head>
<body class="wy-body-for-nav">

    <header id="intro">
        <div class="container">
            <a href="https://stephenharris.github.io/WordPressBehatExtension/"><h1>WordPress Behat Extension</h1></a>
            <p>Automatted end-user testing for WordPress with Behat 3</p>
        </div>
    </header>

    <div class="container">

        <section class="col-md-9">

                        <div class="wy-nav-content">
                <div class="rst-content">
                    <div role="main" class="document">
                        <h1 id="travis">Travis</h1>
<p>Running your Behat tests with WordPress Behat Extension on travis.</p>
<p>This assumes you have set up (or know how to set up) your GitHub repository with <a href="https://Travis-ci.org">Travis</a>.</p>
<p>We shall using <a href="https://getcomposer.org/">Composer</a> AND <a href="http://wp-cli.org/">WP-Cli</a> (installed as a composer dependancy) to install and configure WordPress, as well as Behat and other required dependencies.</p>
<p><strong>Health warning:</strong> The <code>ci</code> directory created below must be committed to version control, but it should not be included on live installs - i.e. don't include it in what you send to the wordpress.org repository).</p>
<ol>
<li>
<p>Add the following dependencies to your <code>composer.json</code> file:</p>
<pre><code>{
 ...
 "require-dev": {
   "wp-cli/wp-cli" : "~0.24",
   "behat/behat": "~3.1.0",
   "behat/mink": "~1.7.1",
   "behat/mink-extension": "~2.0",
   "behat/mink-goutte-driver": "~1.1",
   "behat/mink-selenium2-driver": "~1.3.1",
   "stephenharris/wordpress-behat-extension": "0.3.0"
 },
 ...
}</code></pre>
</li>
<li>
<p>Define your <code>Behat.yml</code> as follows:</p>
<pre><code>default:
suites:
default:
  contexts:
    - FeatureContext:
    - \StephenHarris\WordPressBehatExtension\Context\WordPressContext
    - \StephenHarris\WordPressBehatExtension\Context\WordPressLoginContext
    - \StephenHarris\WordPressBehatExtension\Context\PostTypes\WordPressPostContext
    - \StephenHarris\WordPressBehatExtension\Context\Terms\WordPressTermContext
    - \StephenHarris\WordPressBehatExtension\Context\Users\WordPressUserContext
    - \StephenHarris\WordPressBehatExtension\Context\Options\WordPressOptionContext
    - \StephenHarris\WordPressBehatExtension\Context\Plugins\WordPressPluginContext
    - \StephenHarris\WordPressBehatExtension\Context\WordPressAdminContext
    - \StephenHarris\WordPressBehatExtension\Context\WordPressEditPostContext
    - \StephenHarris\WordPressBehatExtension\Context\WordPressPostListContext
    - \StephenHarris\WordPressBehatExtension\Context\WordPressMailContext

extensions:
    StephenHarris\WordPressBehatExtension:
      path: '/tmp/wordpress'
      connection:
        db: 'wordpress'
        username: 'root'
        password: ''
      mail:
        directory: '/tmp/mail'
    Behat\MinkExtension:
        base_url: 'http://localhost:8000'
        files_path: '%paths.base%/features/files/'
        goutte:
          guzzle_parameters:
                         curl.options:
                            CURLOPT_SSL_VERIFYPEER: false
                            CURLOPT_CERTINFO: false
                            CURLOPT_TIMEOUT: 120
                         ssl.certificate_authority: false
        selenium2: ~
</code></pre>
</li>
<li>
<p>Create a directory <code>ci</code> in the root of your project and add an (executable) file <code>ci/install-wordpress.sh</code></p>
<p>This downloads and installs WordPress, and creates a <code>wp-config.php</code> file. It leverages <code>wp-cli</code> to do this, but this can be done without <code>wp-cli</code>.</p>
<pre><code>#!/bin/bash

# Exit if anything fails AND echo each command before executing
# http://www.peterbe.com/plog/set-ex
set -ex

if [ $# -lt 3 ]; then
    echo "usage: $0 &lt;db-name&gt; &lt;db-user&gt; &lt;db-pass&gt; [db-host] [wp-version]"
   exit 1
fi

# Set up constant
DB_NAME=$1
DB_USER=$2
DB_PASS=$3
DB_HOST=${4-localhost}
WP_VERSION=${5-latest}

WORDPRESS_SITE_DIR=${WORDPRESS_SITE_DIR-/tmp/wordpress}

# Install database for WordPress
mysql --user="$DB_USER" --password="$DB_PASS" $EXTRA -e "DROP DATABASE IF EXISTS $DB_NAME";
mysqladmin --no-defaults create $DB_NAME --user="$DB_USER" --password="$DB_PASS"$EXTRA;

# Download WordPress
mkdir -p $WORDPRESS_SITE_DIR
vendor/bin/wp core download --force --version=$WP_VERSION --path=$WORDPRESS_SITE_DIR

# Create configs
rm -f ${WORDPRESS_SITE_DIR}wp-config.php
vendor/bin/wp core config --path=$WORDPRESS_SITE_DIR --dbname=$DB_NAME --dbuser=$DB_USER --dbpass=$DB_PASS --dbhost=$DB_HOST

# We only run the install command so that we can run further wp-cli commands
vendor/bin/wp core install --path=$WORDPRESS_SITE_DIR --url="wp.dev" --title="wp.dev" --admin_user="admin" --admin_password="password" --admin_email="admin@wp.dev"

# Copy our test subject to the plugins directory
# (You will probably want to create a 'build' version of your plug-in and copy that instead).
rsync -av --exclude=".*" $TRAVIS_BUILD_DIR ${WORDPRESS_SITE_DIR}wp-content/plugins/</code></pre>
</li>
<li>
<p>Create an (executable) file <code>ci/init-behat.sh</code></p>
<p>This is only required for tests that require Javascript to execute. It
downloads and starts selenium.</p>
<pre><code>WORDPRESS_SITE_DIR=${WORDPRESS_SITE_DIR-/tmp/wordpress}

# Used when waiting for stuff
NAP_LENGTH=1
SELENIUM_PORT=4444

# Wait for a specific port to respond to connections.
wait_for_port() {
  local PORT=$1
  while echo | telnet localhost $PORT 2&gt;&amp;1 | grep -qe 'Connection refused'; do
    echo "Connection refused on port $PORT. Waiting $NAP_LENGTH seconds..."
    sleep $NAP_LENGTH
  done
}

rm -f /tmp/.X0-lock

Xvfb &amp; export DISPLAY=localhost:0.0

echo 'start php';
php -S localhost:8000 -t $WORDPRESS_SITE_DIR -d disable_functions=mail &gt; /dev/null 2&gt;&amp;1 &amp;

# Start Selenium
wget http://selenium-release.storage.googleapis.com/2.53/selenium-server-standalone-2.53.1.jar
java -jar selenium-server-standalone-2.53.1.jar -p $SELENIUM_PORT &gt; /dev/null 2&gt;&amp;1 &amp;

# Wait for Selenium, if necessary
wait_for_port $SELENIUM_PORT

echo 'waiting to start tests...';
sleep 5</code></pre>
</li>
<li>
<p>Finally, add your <code>.travis.yml</code> file to your project:</p>
<p>In this example we run the tests on PHP 5.5, and WordPress versions 4.4.4, latest stable version and the nightly version.</p>
<pre><code>language: php

sudo: false

php:
- 5.5

env:
- WP_VERSION=nightly
- WP_VERSION=latest
- WP_VERSION=4.4.4

matrix:
 allow_failures:
   - env: WP_VERSION=nightly

before_install:
 - export WORDPRESS_SITE_DIR="/tmp/wordpress/"
 - composer self-update

install:
 # Install dependencies
 - composer update --no-interaction --prefer-dist;

 # install wordpress
 - bash ./ci/prepare.sh wordpress root '' localhost $WP_VERSION

 # start selenium
 - bash ./ci/pre-behat.sh

script:
 # Run behat tests.
 - vendor/bin/behat</code></pre>
</li>
</ol>
<p>Then commit all the files and push to GitHub.</p>
<h2 id="examples">Examples</h2>
<p>The following projects run WordPressBehatExtension on travis</p>
<ul>
<li><a href="https://github.com/stephenharris/WordPressBehatExtension">This one!</a></li>
<li><a href="https://github.com/stephenharris/Event-Organiser">Event Organiser</a></li>
<li><a href="https://github.com/stephenharris/test-test">Test-Test</a> - a dummy WordPress plugin to demonstrate unit, integrate and automated end-to-end testing</li>
</ul>
                    </div>
                </div>
            </div>

        </section>

        <nav class="col-md-3">

            <div role="navigation" aria-label="main navigation">
                <ul>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="https://stephenharris.github.io/WordPressBehatExtension/Recipes.html">
                                Quick start Recipes
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="https://stephenharris.github.io/WordPressBehatExtension/Contexts.html">
                                Contexts
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="https://stephenharris.github.io/WordPressBehatExtension/Step_Definitions.html">
                                Step Definitions
                            </a>
                        </li>
                                            <li class="toctree-l1 ">
                            <a class="reference internal "
                               href="https://stephenharris.github.io/WordPressBehatExtension/Helper_Classes.html">
                                Helper Classes
                            </a>
                        </li>
                                    </ul>
            </div>
            &nbsp;
        </nav>

    </div>

    <footer class="container">
       <hr/>
                Built with <a href="http://couscous.io/">Couscous</a>.
    </footer>

    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/yaml.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/gherkin.min.js"></script>

    <script>
        $(function() {
            hljs.initHighlighting();
        });
    </script>

</body>
</html>
